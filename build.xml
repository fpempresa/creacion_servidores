<?xml version="1.0" encoding="UTF-8"?>
<project name="proyecto_software" default="default" basedir=".">
    <description>Crea y configura todos los servidores de un proyecto de software en OpenShift</description>
    <import file="base.xml"/>

	<target name="default" depends="create-domain,create-app-jenkins,create-app-project,deploy-project" />
	

	<target name="create-domain" depends="-configureAnt">
		<echo>Vas a destruir toda la informacion de una cuenta de OpenShift</echo>
		<input
			message="Escribe el nombre del entorno en el que crees que estas:"
			validargs="PRODUCCION,PREPRODUCCION,PRUEBAS"
			addproperty="ENVIRONMENT_RESPONSE"
		/>	
		<if>
			<equals arg1="${ENVIRONMENT_RESPONSE}" arg2="${APP_ENVIRONMENT}" />
			<then>
				<createdomainandkeys 
					userName="${OPENSHIFT_LOGIN}" 
					password="${OPENSHIFT_PASSWORD}" 
					domainName="${DOMAIN}" 
					privateKeyFile="${PRIVATE_KEY}"
				/>
			</then>
			<else>
				<fail message="no estamos en ese entorno. Estamos en ${APP_ENVIRONMENT}"/>
			</else>
		</if>
	</target>

	<target name="create-app-jenkins" depends="-configureAnt">
		<createapplication     
			userName="${OPENSHIFT_LOGIN}" 
			password="${OPENSHIFT_PASSWORD}" 
			domainName="${DOMAIN}" 
			applicationName="${JENKINS}"  
			cartridgeName="jenkins"
			gearProfileName="small"
			scalable="false"
		/>
		
		<echo>Añadiendo variable de entorno APP_ENVIRONMENT</echo>
		<addenvironmentvariable     
			userName="${OPENSHIFT_LOGIN}" 
			password="${OPENSHIFT_PASSWORD}" 
			domainName="${DOMAIN}" 
			applicationName="${JENKINS}"
			environmentVariableName="APP_ENVIRONMENT" 
			environmentVariableValue="${APP_ENVIRONMENT}"
		/>
			
		<antcall target="show-jenkins-password">
		</antcall>
	
	</target>

	<target name="create-app-project" depends="-configureAnt">
		<antcall target="backup">
		</antcall>
	
		<createprojectapplication	
			userName="${OPENSHIFT_LOGIN}" 
			password="${OPENSHIFT_PASSWORD}" 
			domainName="${DOMAIN}" 
			applicationName="${APPLICATION}" 
		/>
		
		<antcall target="restore">
		</antcall>
	</target>

	<target name="deploy-project" depends="-configureAnt">
		<configureserver
			userName="${OPENSHIFT_LOGIN}" 
			password="${OPENSHIFT_PASSWORD}"  
			domainName="${DOMAIN}" 
			applicationName="${APPLICATION}"
			privateKeyFile="${PRIVATE_KEY}"
			gitRepository="${GIT_REPOSITORY_APP}"
		>
			<copy file="../${PROJECT_NAME}/dist/${PROJECT_NAME}.war" tofile="@{gitlocalpath}/webapps/ROOT.war" overwrite="true" />	
		</configureserver>
	</target>

	<target name="show-log-catalina" depends="-configureAnt">
		<remote-exec 
			userName="${OPENSHIFT_LOGIN}" 
			password="${OPENSHIFT_PASSWORD}"  
			domainName="${DOMAIN}" 
			applicationName="${APPLICATION}"
			privateKeyFile="${PRIVATE_KEY}"
			cmd="cat $OPENSHIFT_JBOSSEWS_DIR/logs/catalina.out"
		/>	
	</target>
	<target name="show-log-files" depends="-configureAnt">
		<remote-exec 
			userName="${OPENSHIFT_LOGIN}" 
			password="${OPENSHIFT_PASSWORD}"  
			domainName="${DOMAIN}" 
			applicationName="${APPLICATION}"
			privateKeyFile="${PRIVATE_KEY}"
			cmd="ls -l $OPENSHIFT_JBOSSEWS_DIR/logs"
		/>	
	</target>
	<target name="show-env" depends="-configureAnt">
		<remote-exec 
			userName="${OPENSHIFT_LOGIN}" 
			password="${OPENSHIFT_PASSWORD}"  
			domainName="${DOMAIN}" 
			applicationName="${APPLICATION}"
			privateKeyFile="${PRIVATE_KEY}"
			cmd="env"
		/>	
	</target>	
	<target name="backup" depends="-configureAnt">
		
	</target>

	<target name="restore" depends="-configureAnt">
	</target>

	<target name="restart" depends="-configureAnt">
		<restartapplication 
			userName="${OPENSHIFT_LOGIN}" 
			password="${OPENSHIFT_PASSWORD}" 
			domainName="${DOMAIN}" 
			applicationName="${APPLICATION}" 
		/>	
	</target>
	<target name="show-project-sshurl" depends="-configureAnt">
		<!-- Mostrar la url de conexion de ssh de jenkins -->
		
		<applicationproperty     
			userName="${OPENSHIFT_LOGIN}" 
			password="${OPENSHIFT_PASSWORD}" 
			domainName="${DOMAIN}" 
			applicationName="${APPLICATION}"  
			name="SSH_URL" 
			applicationProperty="SshUrl"
		/>
		
		<echo>SSH URL del domino ${DOMAIN} en aplicacion ${APPLICATION}</echo>
		<echo>${SSH_URL}</echo>
		
	</target>
	
	<target name="show-jenkins-sshurl" depends="-configureAnt">
		<!-- Mostrar la url de conexion de ssh de jenkins -->
		
		<applicationproperty     
			userName="${OPENSHIFT_LOGIN}" 
			password="${OPENSHIFT_PASSWORD}" 
			domainName="${DOMAIN}" 
			applicationName="${JENKINS}"  
			name="SSH_URL" 
			applicationProperty="SshUrl"
		/>
		
		<echo>SSH URL del domino ${DOMAIN} en aplicacion ${JENKINS}</echo>
		<echo>${SSH_URL}</echo>
		
	</target>	

	<target name="show-jenkins-password" depends="-configureAnt">
		<!-- Mostrar el usuario y la contraseña de Jenkins -->

		
		<remote-exec   
			userName="${OPENSHIFT_LOGIN}" 
			password="${OPENSHIFT_PASSWORD}" 
			domainName="${DOMAIN}" 
			applicationName="${JENKINS}" 
			privateKeyFile="${PRIVATE_KEY}"
			cmd="echo usuario:$JENKINS_USERNAME contraenya:$JENKINS_PASSWORD"
		/>
	
	</target>
	
</project>