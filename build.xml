<?xml version="1.0" encoding="UTF-8"?>
<project name="fpempresa" default="default" basedir=".">
    <description>Crea y configura todos los servidores de fpempresa</description>
  
    <target name="default" depends="-configureAnt" >        
		
		
		
		
    </target>


	<target name="deploy-produccion" depends="-configureAnt" >
	
	</target>
	
	<target name="deploy-preproduccion" depends="-configureAnt" >
	</target>
	
	<target name="deploy-pruebas" depends="-configureAnt" >
	</target>
	
	<target name="deploy-desarrollo" depends="-configureAnt" >
	</target>	
	
	<target name="deploy-log" depends="-configureAnt,deploy-log-elasticsearch,deploy-log-kibana" >	
	</target>	
	
	<target name="deploy-log-elasticsearch" depends="-configureAnt" >
		<property name="LOCAL_PATH_GIT_ELASTICSEARCH" value="${env.TMP}/${APP_NAME}/${LOG_DOMAIN}/${ELASTICSEARCH_APPLICATION}" />
	
		<delete includeEmptyDirs="true" >
		  <fileset defaultexcludes="no"  dir="${LOCAL_PATH_GIT_ELASTICSEARCH}" includes="**/*"/>
		</delete>
		<mkdir dir="${LOCAL_PATH_GIT_ELASTICSEARCH}" />
	
		<gitcloneapplication     
			userName="${OPENSHIFT_LOG_LOGIN}" 
			password="${OPENSHIFT_LOG_PASSWORD}" 
			domainName="${LOG_DOMAIN}" 
			applicationName="${ELASTICSEARCH_APPLICATION}"  
			privateKeyFile="${LOG_PRIVATE_KEY}"
			path="${LOCAL_PATH_GIT_ELASTICSEARCH}"
		/>
		
		<git 
			command="remote" 
			options="add upstream -m master ${GIT_REPOSITORY_ELASTICSEARCH}"
			dir="${LOCAL_PATH_GIT_ELASTICSEARCH}"
		/>
		
		
		<git 
			command="pull" 
			options="-s recursive -X theirs upstream master"
			dir="${LOCAL_PATH_GIT_ELASTICSEARCH}"
		/>			
		
		<echo>Iniciando push</echo>
		<gitpushapplication     
			userName="${OPENSHIFT_LOG_LOGIN}" 
			password="${OPENSHIFT_LOG_PASSWORD}" 
			domainName="${LOG_DOMAIN}" 
			applicationName="${ELASTICSEARCH_APPLICATION}"  
			privateKeyFile="${LOG_PRIVATE_KEY}"
			path="${LOCAL_PATH_GIT_ELASTICSEARCH}"
		/>
				
	
	</target>	
	<target name="deploy-log-kibana" depends="-configureAnt" >
		<property name="LOCAL_PATH_GIT_KIBANA" value="${env.TMP}/${APP_NAME}/${LOG_DOMAIN}/${KIBANA_APPLICATION}" />
	
	
		<delete includeEmptyDirs="true" >
		  <fileset defaultexcludes="no"  dir="${LOCAL_PATH_GIT_KIBANA}" includes="**/*"/>
		</delete>	
		<mkdir dir="${LOCAL_PATH_GIT_KIBANA}" />
	
		<gitcloneapplication     
			userName="${OPENSHIFT_LOG_LOGIN}" 
			password="${OPENSHIFT_LOG_PASSWORD}" 
			domainName="${LOG_DOMAIN}" 
			applicationName="${KIBANA_APPLICATION}"  
			privateKeyFile="${LOG_PRIVATE_KEY}"
			path="${LOCAL_PATH_GIT_KIBANA}"
		/>

		<git 
			command="remote" 
			options="add upstream -m master ${GIT_REPOSITORY_KIBANA}"
			dir="${LOCAL_PATH_GIT_KIBANA}"
		/>
		<git 
			command="pull" 
			options="-s recursive -X theirs upstream master"
			dir="${LOCAL_PATH_GIT_KIBANA}"
		/>			
		
		<echo>Iniciando push</echo>
		<gitpushapplication     
			userName="${OPENSHIFT_LOG_LOGIN}" 
			password="${OPENSHIFT_LOG_PASSWORD}" 
			domainName="${LOG_DOMAIN}" 
			applicationName="${KIBANA_APPLICATION}"  
			privateKeyFile="${LOG_PRIVATE_KEY}"
			path="${LOCAL_PATH_GIT_KIBANA}"
		/>
				
		
	</target>


	<target name="create-server-produccion" depends="-configureAnt" >
	
		<removeallpublickeys 
			userName="${OPENSHIFT_PRODUCCION_LOGIN}" 
			password="${OPENSHIFT_PRODUCCION_PASSWORD}"  
		/>
		<destroyalldomains     
			userName="${OPENSHIFT_PRODUCCION_LOGIN}" 
			password="${OPENSHIFT_PRODUCCION_PASSWORD}" 
			force="true" 
		/>
	
		<createkeypair     
			privateKeyFile="${PRODUCCION_PRIVATE_KEY}"
		/>
		<addpublickey     
			userName="${OPENSHIFT_PRODUCCION_LOGIN}" 
			password="${OPENSHIFT_PRODUCCION_PASSWORD}" 
			publicKeyName="ant" 
			publicKeyFile="${PRODUCCION_PUBLIC_KEY}"
		/>
		<createdomain     
			userName="${OPENSHIFT_PRODUCCION_LOGIN}" 
			password="${OPENSHIFT_PRODUCCION_PASSWORD}" 
			domainName="${PRODUCCION_DOMAIN}" 
			
		/>
		<createapplication     
			userName="${OPENSHIFT_PRODUCCION_LOGIN}" 
			password="${OPENSHIFT_PRODUCCION_PASSWORD}" 
			domainName="${PRODUCCION_DOMAIN}" 
			applicationName="${PRODUCCION_APPLICATION}"  
			cartridgeName="jbossews-2.0"
			gearProfileName="small"
			scalable="true"
		/>
		<addcartridge     
			userName="${OPENSHIFT_PRODUCCION_LOGIN}" 
			password="${OPENSHIFT_PRODUCCION_PASSWORD}" 
			domainName="${PRODUCCION_DOMAIN}" 
			applicationName="${PRODUCCION_APPLICATION}"  
			cartridgeName="mysql-5.5" 
		/>
	</target>
	
	<target name="create-server-preproduccion" depends="-configureAnt" >
		<removeallpublickeys 
			userName="${OPENSHIFT_PREPRODUCCION_LOGIN}" 
			password="${OPENSHIFT_PREPRODUCCION_PASSWORD}"  
		/>
		<destroyalldomains     
			userName="${OPENSHIFT_PREPRODUCCION_LOGIN}" 
			password="${OPENSHIFT_PREPRODUCCION_PASSWORD}" 
			force="true" 
		/>
	
		<createkeypair     
			privateKeyFile="${PREPRODUCCION_PRIVATE_KEY}"
		/>
		<addpublickey     
			userName="${OPENSHIFT_PREPRODUCCION_LOGIN}" 
			password="${OPENSHIFT_PREPRODUCCION_PASSWORD}" 
			publicKeyName="ant" 
			publicKeyFile="${PREPRODUCCION_PUBLIC_KEY}"
		/>
		<createdomain     
			userName="${OPENSHIFT_PREPRODUCCION_LOGIN}" 
			password="${OPENSHIFT_PREPRODUCCION_PASSWORD}" 
			domainName="${PREPRODUCCION_DOMAIN}" 
			
		/>
		<createapplication     
			userName="${OPENSHIFT_PREPRODUCCION_LOGIN}" 
			password="${OPENSHIFT_PREPRODUCCION_PASSWORD}" 
			domainName="${PREPRODUCCION_DOMAIN}" 
			applicationName="${PREPRODUCCION_APPLICATION}"  
			cartridgeName="jbossews-2.0"
			gearProfileName="small"
			scalable="true"
		/>
		<addcartridge     
			userName="${OPENSHIFT_PREPRODUCCION_LOGIN}" 
			password="${OPENSHIFT_PREPRODUCCION_PASSWORD}" 
			domainName="${PREPRODUCCION_DOMAIN}" 
			applicationName="${PREPRODUCCION_APPLICATION}"  
			cartridgeName="mysql-5.5" 
		/>	
	</target>
	
	<target name="create-server-pruebas" depends="-configureAnt" >
		<removeallpublickeys 
			userName="${OPENSHIFT_PRUEBAS_LOGIN}" 
			password="${OPENSHIFT_PRUEBAS_PASSWORD}"  
		/>
		<destroyalldomains     
			userName="${OPENSHIFT_PRUEBAS_LOGIN}" 
			password="${OPENSHIFT_PRUEBAS_PASSWORD}" 
			force="true" 
		/>
	
		<createkeypair     
			privateKeyFile="${PRUEBAS_PRIVATE_KEY}"
		/>
		<addpublickey     
			userName="${OPENSHIFT_PRUEBAS_LOGIN}" 
			password="${OPENSHIFT_PRUEBAS_PASSWORD}" 
			publicKeyName="ant" 
			publicKeyFile="${PRUEBAS_PUBLIC_KEY}"
		/>
		<createdomain     
			userName="${OPENSHIFT_PRUEBAS_LOGIN}" 
			password="${OPENSHIFT_PRUEBAS_PASSWORD}" 
			domainName="${PRUEBAS_DOMAIN}" 
			
		/>
		<createapplication     
			userName="${OPENSHIFT_PRUEBAS_LOGIN}" 
			password="${OPENSHIFT_PRUEBAS_PASSWORD}" 
			domainName="${PRUEBAS_DOMAIN}" 
			applicationName="${PRUEBAS_APPLICATION}"  
			cartridgeName="jbossews-2.0"
			gearProfileName="small"
			scalable="true"
		/>
		<addcartridge     
			userName="${OPENSHIFT_PRUEBAS_LOGIN}" 
			password="${OPENSHIFT_PRUEBAS_PASSWORD}" 
			domainName="${PRUEBAS_DOMAIN}" 
			applicationName="${PRUEBAS_APPLICATION}"  
			cartridgeName="mysql-5.5" 
		/>	
	</target>
	
	<target name="create-server-desarrollo" depends="-configureAnt" >
	</target>
	
	<target name="create-server-log" depends="-configureAnt" >
		<removeallpublickeys 
			userName="${OPENSHIFT_LOG_LOGIN}" 
			password="${OPENSHIFT_LOG_PASSWORD}"  
		/>
		<destroyalldomains     
			userName="${OPENSHIFT_LOG_LOGIN}" 
			password="${OPENSHIFT_LOG_PASSWORD}" 
			force="true" 
		/>
	
		<createkeypair     
			privateKeyFile="${LOG_PRIVATE_KEY}"
		/>
		<addpublickey     
			userName="${OPENSHIFT_LOG_LOGIN}" 
			password="${OPENSHIFT_LOG_PASSWORD}" 
			publicKeyName="ant" 
			publicKeyFile="${LOG_PUBLIC_KEY}"
		/>
		<createdomain     
			userName="${OPENSHIFT_LOG_LOGIN}" 
			password="${OPENSHIFT_LOG_PASSWORD}" 
			domainName="${LOG_DOMAIN}" 
			
		/>

		<createapplication     
			userName="${OPENSHIFT_LOG_LOGIN}" 
			password="${OPENSHIFT_LOG_PASSWORD}" 
			domainName="${LOG_DOMAIN}" 
			applicationName="${ELASTICSEARCH_APPLICATION}"  
			cartridgeName="diy-0.1"
			gearProfileName="small"
			scalable="false"
		/>
		<createapplication     
			userName="${OPENSHIFT_LOG_LOGIN}" 
			password="${OPENSHIFT_LOG_PASSWORD}" 
			domainName="${LOG_DOMAIN}" 
			applicationName="${KIBANA_APPLICATION}"  
			cartridgeName="php-5.4"
			gearProfileName="small"
			scalable="false"
		/>		
		
	</target>
	
	

	<target name="backup-database-produccion" depends="-configureAnt" >
	</target>
	
	<target name="backup-database-preproduccion" depends="-configureAnt" >
	</target>
	
	<target name="backup-database-pruebas" depends="-configureAnt" >
	</target>

	
	
	<target name="restore-database-produccion" depends="-configureAnt" >
	</target>
	
	<target name="restore-database-preproduccion" depends="-configureAnt" >
	</target>
	
	<target name="restore-database-pruebas" depends="-configureAnt" >
	</target>
 
    <target name="-configureAnt">
        <echo>Configurando librerias de Ant</echo>

        <property name="libAnt.path" value="libant" />

        <path id="libAnt.classpath">
            <fileset dir="${libAnt.path}">
                <include name="**/*.jar" />
            </fileset>
        </path>
		
		<!-- OpenShift -->
		<taskdef classpathref="libAnt.classpath" resource="es/logongas/openshift/ant/antlib.xml" />
        <!-- El try-cath -->
        <taskdef classpathref="libAnt.classpath" resource="net/sf/antcontrib/antcontrib.properties"/>
        <!-- Manejo de ficheros XML -->
        <taskdef classpathref="libAnt.classpath" name="xmltask" classname="com.oopsconsultancy.xmltask.ant.XmlTask"/>
		<!-- Flyway -->
		<taskdef classpathref="libAnt.classpath" resource="com/googlecode/flyway/ant/antlib.xml" />
		<!-- Cargar todas las variables de entorno -->
		<property environment="env"/>
		<!-- Cargar el fichero de propiedades -->
		<property file="proyecto.properties "/>
	   
		<property name="SSH_KEYS_FOLDER" value="../.ssh-${APP_NAME}" />
		<mkdir dir="${SSH_KEYS_FOLDER}" />
		
		<property name="PRODUCCION_PRIVATE_KEY" value="${SSH_KEYS_FOLDER}/pro_rsa" />
		<property name="PRODUCCION_PUBLIC_KEY" value="${PRODUCCION_PRIVATE_KEY}.pub" />
		<property name="PRODUCCION_DOMAIN" value="pro${APP_NAME}" />
		<property name="PRODUCCION_APPLICATION" value="app" />
		<property name="PRODUCCION_LOGSTASH_APPLICATION" value="logstash" />
		
		<property name="PREPRODUCCION_PRIVATE_KEY" value="${SSH_KEYS_FOLDER}/pre_rsa" />
		<property name="PREPRODUCCION_PUBLIC_KEY" value="${PREPRODUCCION_PRIVATE_KEY}.pub" />
		<property name="PREPRODUCCION_DOMAIN" value="pre${APP_NAME}" />
		<property name="PREPRODUCCION_APPLICATION" value="app" />
		<property name="PREPRODUCCION_LOGSTASH_APPLICATION" value="logstash" />
		
		<property name="PRUEBAS_PRIVATE_KEY" value="${SSH_KEYS_FOLDER}/pru_rsa" />
		<property name="PRUEBAS_PUBLIC_KEY" value="${PRUEBAS_PRIVATE_KEY}.pub" />
		<property name="PRUEBAS_DOMAIN" value="pru${APP_NAME}" />
		<property name="PRUEBAS_APPLICATION" value="app" />
		<property name="PRUEBAS_LOGSTASH_APPLICATION" value="logstash" />
		
		
		<property name="DESARROLLO_PRIVATE_KEY" value="${SSH_KEYS_FOLDER}/dev_rsa" />
		<property name="DESARROLLO_PUBLIC_KEY" value="${DESARROLLO_PRIVATE_KEY}.pub" />
		<property name="DESARROLLO_DOMAIN" value="dev${APP_NAME}" />
		<property name="JENKINS_APPLICATION" value="jenkins" />
		
		
		<property name="LOG_PRIVATE_KEY" value="${SSH_KEYS_FOLDER}/log_rsa" />
		<property name="LOG_PUBLIC_KEY" value="${LOG_PRIVATE_KEY}.pub" />
		<property name="LOG_DOMAIN" value="log${APP_NAME}" />	
		<property name="ELASTICSEARCH_APPLICATION" value="elasticsearch" />			
		<property name="KIBANA_APPLICATION" value="kibana" />	
		
    </target> 	
		
	
</project>
